<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AI LLM iPhone Geolocation Finder</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --muted:#9aa4b2; --accent:#00c2a8; --danger:#ff6961;
    --glass: rgba(255,255,255,0.03);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #071025 60%);color:#e6eef6}
  .wrap{max-width:900px;margin:18px auto;padding:14px}
  header{display:flex;gap:12px;align-items:center}
  h1{font-size:1.15rem;margin:0;font-weight:600}
  .meta{color:var(--muted);font-size:0.85rem}
  .card{background:var(--card);border-radius:14px;padding:12px;margin-top:14px;box-shadow:0 6px 20px rgba(1,4,9,0.6)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 220px;min-width:180px}
  .big{font-size:1.05rem;font-weight:600}
  .muted{color:var(--muted);font-size:0.9rem}
  button{background:linear-gradient(90deg, var(--accent), #00e3c0);border:0;color:#021216;padding:10px 12px;border-radius:10px;font-weight:600}
  button.warn{background:linear-gradient(90deg,#ff8d7a,#ff5a4f);color:#fff}
  #map{height:260px;border-radius:10px;overflow:hidden}
  pre{background:var(--glass);padding:10px;border-radius:10px;overflow:auto;color:#dff7f0}
  .small{font-size:0.85rem}
  .device-hint{font-size:0.85rem;color:var(--muted);margin-top:6px}
  footer{margin-top:12px;color:var(--muted);font-size:0.8rem;text-align:center}
  @media (max-width:420px){
    .row{flex-direction:column}
    #map{height:220px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>AI LLM iPhone Geolocation Finder</h1>
        <div class="meta">Instant location, map, and LLM context actions</div>
      </div>
    </header>

    <div class="card" id="controls">
      <div class="row">
        <div class="col">
          <div class="big" id="coords">—</div>
          <div class="muted">Latitude, Longitude</div>
        </div>
        <div class="col">
          <div class="big" id="accuracy">—</div>
          <div class="muted">Accuracy (meters)</div>
        </div>
        <div class="col">
          <div class="big" id="altitude">—</div>
          <div class="muted">Altitude</div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div style="flex:1 1 360px">
          <button id="getLoc">Get Location Now</button>
          <button id="watchToggle" style="margin-left:8px">Start Live</button>
          <button id="sendLLM" style="margin-left:8px">Send to LLM</button>
        </div>
        <div style="min-width:180px;text-align:right">
          <div class="device-hint" id="deviceHint"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="muted small">LLM prompt (optional)</label>
        <textarea id="llmPrompt" rows="2" style="width:100%;margin-top:6px;border-radius:10px;padding:8px;background:var(--glass);border:0;color:#e6eef6"></textarea>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <div id="map" aria-hidden="false"></div>
        </div>
        <div class="col">
          <div class="muted small">Latest Position JSON</div>
          <pre id="jsonOut">{}</pre>
          <div style="margin-top:8px">
            <div class="muted small">LLM Response</div>
            <pre id="llmOut">No response yet</pre>
          </div>
        </div>
      </div>
    </div>

    <footer>Designed for mobile Safari; replace /api/llm with your LLM backend</footer>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>
<script>
/* --- Simple device hint (detect modern iPhone UI) --- */
(function(){
  const ua = navigator.userAgent || '';
  const isIPhone = /iPhone/.test(ua);
  const deviceHint = document.getElementById('deviceHint');
  if(isIPhone){
    deviceHint.textContent = 'iPhone detected — optimized for mobile Safari';
  } else {
    deviceHint.textContent = 'Mobile-optimized UI';
  }
})();

/* --- Map initialization (Leaflet) --- */
let map, marker;
function initMap(){
  try{
    map = L.map('map', {zoomControl:true, attributionControl:false}).setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);
    marker = L.marker([0,0]).addTo(map);
  }catch(e){
    document.getElementById('map').innerHTML = 'Map unavailable';
  }
}
initMap();

/* --- UI elements --- */
const coordsEl = document.getElementById('coords');
const accuracyEl = document.getElementById('accuracy');
const altitudeEl = document.getElementById('altitude');
const jsonOut = document.getElementById('jsonOut');
const llmOut = document.getElementById('llmOut');
const getLocBtn = document.getElementById('getLoc');
const watchToggleBtn = document.getElementById('watchToggle');
const sendLLMBtn = document.getElementById('sendLLM');
const llmPrompt = document.getElementById('llmPrompt');

let watchId = null;
let lastPosition = null;

/* --- Format helpers --- */
function formatCoords(pos){
  const lat = pos.coords.latitude.toFixed(6);
  const lng = pos.coords.longitude.toFixed(6);
  return lat + ' , ' + lng;
}
function updateUI(pos){
  lastPosition = pos;
  coordsEl.textContent = formatCoords(pos);
  accuracyEl.textContent = (pos.coords.accuracy || '—') + ' m';
  altitudeEl.textContent = (pos.coords.altitude !== null ? pos.coords.altitude + ' m' : '—');
  jsonOut.textContent = JSON.stringify({
    timestamp: new Date(pos.timestamp).toISOString(),
    latitude: pos.coords.latitude,
    longitude: pos.coords.longitude,
    accuracy: pos.coords.accuracy,
    altitude: pos.coords.altitude,
    heading: pos.coords.heading,
    speed: pos.coords.speed
  }, null, 2);
  if(marker && map){
    marker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
    map.setView([pos.coords.latitude, pos.coords.longitude], Math.max(map.getZoom(), 15));
  }
}

/* --- Geo actions --- */
function handleError(err){
  console.warn('Geolocation error', err);
  switch(err.code){
    case 1: alert('Permission denied. Please allow location access in Safari settings.'); break;
    case 2: alert('Position unavailable.'); break;
    case 3: alert('Request timed out.'); break;
    default: alert('Unknown geolocation error.'); break;
  }
}
getLocBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{ updateUI(pos); }, handleError, {enableHighAccuracy:true, maximumAge:5000, timeout:10000});
});

watchToggleBtn.addEventListener('click', ()=>{
  if(watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    watchToggleBtn.textContent = 'Start Live';
    watchToggleBtn.classList.remove('warn');
  } else {
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
    watchId = navigator.geolocation.watchPosition((pos)=>{ updateUI(pos); }, handleError, {enableHighAccuracy:true, maximumAge:2000, timeout:10000});
    watchToggleBtn.textContent = 'Stop Live';
    watchToggleBtn.classList.add('warn');
  }
});

/* --- LLM integration (frontend contract) ---
   Replace POST URL with your backend endpoint that takes JSON:
   { location: { latitude, longitude, accuracy, altitude, timestamp }, prompt: string }
   Backend must hold the LLM API key and call the LLM provider.
--- */
sendLLMBtn.addEventListener('click', async ()=>{
  if(!lastPosition){ alert('No location available yet. Tap Get Location Now.'); return; }
  const payload = {
    location: {
      latitude: lastPosition.coords.latitude,
      longitude: lastPosition.coords.longitude,
      accuracy: lastPosition.coords.accuracy,
      altitude: lastPosition.coords.altitude,
      timestamp: new Date(lastPosition.timestamp).toISOString()
    },
    prompt: llmPrompt.value || 'Give a short description of this location, including travel tips and any obvious hazards.'
  };
  llmOut.textContent = '⏳ contacting backend...';
  try{
    const resp = await fetch('/api/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const txt = await resp.text();
      llmOut.textContent = 'Backend error: ' + (txt || resp.status);
      return;
    }
    const data = await resp.json();
    // Expect { answer: "..." } from backend
    llmOut.textContent = data.answer || JSON.stringify(data, null, 2);
  }catch(e){
    llmOut.textContent = 'Network error: ' + e.message;
  }
});

/* --- Optional: auto-get a location on load for convenience (gentle) --- */
if('permissions' in navigator && navigator.permissions.query){
  // Try not to aggressively prompt; only query for information.
  navigator.permissions.query({name:'geolocation'}).then(res=>{
    if(res.state === 'granted'){
      navigator.geolocation.getCurrentPosition((pos)=> updateUI(pos), ()=>{}, {enableHighAccuracy:true});
    }
  }).catch(()=>{});
}
</script>
</body>
</html>
